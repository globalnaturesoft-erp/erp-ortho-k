<% if (params.to_unsafe_hash[:global_filter][:from_date].present? ||
      params.to_unsafe_hash[:global_filter][:to_date].present? ||
      params.to_unsafe_hash[:global_filter][:period].present?) &&
      params.to_unsafe_hash[:global_filter][:customer].present? %>
    
    <div class="custom-show text-center">
        <h4 class="font-blue-madison bold uppercase mb-15">
            Báo cáo tổng số lượng bệnh nhân theo khách hàng <br>
            <span class="font-sm">
                <% if @period_name.nil? %>
                    (<%= 'Từ ' + @from.strftime('%d/%m/%Y') if !@from.nil? %> <%= ' Đến ' + @to.strftime('%d/%m/%Y') if !@to.nil? %>)
                <% else %>
                    (<%= @period_name %>)
                <% end %>
            </span>
        </h4>
    </div>
    
    <div class="text-right mb-10">
        <a target="_blank"
            href="<%= erp_ortho_k.report_new_patient_v2_xlsx_backend_sales_path(params.to_unsafe_hash.merge({format: 'xlsx'})) %>"
            target="_blank"
            class="btn btn-primary"
        >Xuất excel</a>
    </div>
    
    <% patient_states = Erp::OrthoK::PatientState.get_active %>
    <% colspan_qty = patient_states.count %>
    
    <table class="table table-bordered order-column">
        <thead class="">
            <tr>
                <th width="25%" rowspan="2" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Đối tượng khách hàng</th>
                <th colspan="<%= colspan_qty %>" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Số lượng BN</th>
                <th width="65%"rowspan="2"  class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Danh sách BN mới</th>
            </tr>
            <tr>
                <% patient_states.each do |ps| %>
                    <th class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap"><%= ps.name %></th>
                <% end %>
            </tr>
        </thead>
        <tbody>
            <% @customers.each do |customer| %>
                <tr>
                    <td class="text-center uppercase bold"><%= customer.contact_name %></td>
                    <% patient_states.each do |ps| %>
                        <td class="text-center">
                            <% patient_ids = Erp::Contacts::Contact.get_patients_by_state(
                                    patient_state_id: ps.id,
                                    customer_id: customer.id,
                                    from: @from,
                                    to: @to
                                ).map(&:patient_id).uniq
                                
                                patients = Erp::Contacts::Contact.where(id: patient_ids)
                            %>
                            <%= patients.count %>
                        </td>
                    <% end %>
                    <td class="text-justify font-yellow-gold">
                        <%
                            patient_ids = Erp::Contacts::Contact.get_patients_by_state(
                                patient_state_id: Erp::OrthoK::PatientState.get_new_patient.id,
                                customer_id: customer.id,
                                from: @from,
                                to: @to
                            ).map(&:patient_id).uniq
                            
                            new_patients = Erp::Contacts::Contact.where(id: patient_ids)
                        %>
                        <% new_patients.each_with_index do |patient,index| %>
                            <%= patient.name %> <% if index+1 < new_patients.count %><i class='fa fa-genderless bg-font-default'></i><% end %>
                        <% end %>
                    </td>
                </tr>
            <% end %>
            <tr>
                <td class="bg-green-jungle bg-font-green-jungle text-center uppercase bold"><%= 'Tổng cộng' %></td>
                <% patient_states.each do |ps| %>
                    <td class="bg-green-jungle bg-font-green-jungle text-center bold">
                        <% patient_ids = Erp::Contacts::Contact.get_patients_by_state(
                                patient_state_id: ps.id,
                                customer_id: @customer_ids,
                                from: @from,
                                to: @to
                            ).map(&:patient_id).uniq
                                
                            patients = Erp::Contacts::Contact.where(id: patient_ids)
                        %>
                        <%= patients.count %>
                    </td>
                <% end %>
                
                <td class="bg-green-jungle bg-font-green-jungle text-center"></td>
            </tr>
        </tbody>
    </table>
<% else %>
    <div class="alert alert-warning">
        <strong>Vui lòng lựa chọn điều kiện lọc:</strong><br>
        - Mốc thời gian cần báo cáo (Từ ngày - đến ngày <i>hoặc</i> Thời gian cố định).<br>
        - Chọn một hoặc một số khách hàng.
    </div>
<% end %>