<% if (params.to_unsafe_hash[:global_filter][:from_date].present? && params.to_unsafe_hash[:global_filter][:to_date].present?) ||
      params.to_unsafe_hash[:global_filter][:period].present? %>
    
    <div class="custom-show text-center">
        <h4 class="font-blue-madison bold uppercase mb-15">
            Danh sách khách hàng phát sinh giao dịch
            <% if @period_name.nil? %>
                <%= 'Từ ' + @from.strftime('%d/%m/%Y') if !@from.nil? %> <%= ' Đến ' + @to.strftime('%d/%m/%Y') if !@to.nil? %>
            <% else %>
                <%= 'Trong ' + @period_name %>
            <% end %>
        </h4>
    </div>
    
    <div class="text-right mb-10">
        <a target="_blank"
            href="<%= erp_ortho_k.report_liabilities_arising_xlsx_backend_accountings_path(params.to_unsafe_hash.merge({format: 'xlsx'})) %>"
            target="_blank"
            class="btn btn-primary"
        >Xuất excel</a>
    </div>
    
    <table class="table table-bordered order-column">
        <thead class="flip-content">
            <tr>
                <th width="5%"  class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">STT</th>
                <th width="20%"  class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Tên khách hàng</th>
                <th width="10%" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Khu vực/Tỉnh/TP</th>
                <th width="10%" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Tổng nợ</th>
                <th width="10%" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Thực thu</th>
                <th width="10%" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Chưa thu</th>
                <th width="15%" class="text-center bg-yellow-mint bg-font-yellow-mint text-nowrap">Sale phụ trách</th>
            </tr>
        </thead>
        <tbody>
            <% @customers.each_with_index do |customer, index| %>
                <% sales_total_arising = customer.sales_total_amount(from_date: @from, to_date: @to) %>
                <% sales_total = customer.sales_debt_amount(to_date: (!@from.nil? ? (@from-1.day) : @from)) + sales_total_arising %>
                <% sales_paid_arising = customer.sales_paid_amount(from_date: @from, to_date: @to) %>
                <% sales_debt_remain = customer.sales_debt_amount(to_date: @to) %>
                <tr>
                    <td class="text-center"><%= index+1 %></td>
                    <td class="text-left"><%= customer.name %></td>
                    <td class="text-center">
                        <%= customer.state_name %>
                    </td>
                    <td class="text-center">
                        <%= format_number(sales_total) %>
                    </td>
                    <td class="text-center">
                        <%= format_number(sales_paid_arising) %>
                    </td>
                    <td class="text-center">
                        <%= format_number(sales_debt_remain) %>
                    </td>
                    <td class="text-center">
                        <%= !customer.salesperson.nil? ? customer.salesperson_name : '--' %>
                    </td>
                </tr>
            <% end %>
            <% sales_total_arising = @customers.sales_total_amount(from_date: @from, to_date: @to) %>
            <% sales_total = @customers.sales_debt_amount(to_date: (!@from.nil? ? (@from-1.day) : @from)) + sales_total_arising %>
            <% sales_paid_arising = @customers.sales_paid_amount(from_date: @from, to_date: @to) %>
            <% sales_debt_remain = @customers.sales_debt_amount(to_date: @to) %>
            <tr>
                <td class="bg-green-jungle bg-font-green-jungle border-green-jungle text-center bold" colspan="3">TỔNG CỘNG</td>
                <td class="bg-green-jungle bg-font-green-jungle border-green-jungle text-center bold"><%= format_number(sales_total) %></td>
                <td class="bg-green-jungle bg-font-green-jungle border-green-jungle text-center bold"><%= format_number(sales_paid_arising) %></td>
                <td class="bg-green-jungle bg-font-green-jungle border-green-jungle text-center bold"><%= format_number(sales_debt_remain) %></td>
                <td class="bg-green-jungle bg-font-green-jungle border-green-jungle text-center bold"></td>
            </tr>
        </tbody>
    </table>
<% else %>
    <div class="alert alert-warning"><%= t('.please_select_filter') %></div>
<% end %>