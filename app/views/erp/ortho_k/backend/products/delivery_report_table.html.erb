<% if params[:global_filter][:from_date].present? and params[:global_filter][:to_date].present? %>
    <% if @group_by_category.nil? and @group_by_property.nil? %>
        <%= render 'erp/ortho_k/backend/products/delivery_report_table/default' %>
    <% elsif @group_by_property.nil? %>
        <table class="table table-bordered table-advance order-column" id="">
            <% product_ids = ([-1] + @products_query.select('id')) %>
            <tr>
                <td class="text-right text-nowrap">Tổng cộng</td>
                <td class="text-center stock-num text-bold bg-warning">
                    <%
                        begin_params = @global_filters.clone
                        begin_params[:to_date] = @global_filters[:from_date]
                        begin_params[:from_date] = nil
                        begin_params[:product_id] = product_ids
                    %>
                    <%= Erp::Products::Product.get_stock_real(begin_params) %>
                </td>
                <% total_import = 0 %>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_import(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_WAREHOUSE_IMPORT
                        }))
                        total_import += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_import(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOMER_IMPORT
                        }))
                        total_import += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_transfer_import(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_import += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    --
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_stock_check_import(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_import += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_import(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOM_IMPORT
                        }))
                        total_import += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num text-bold text-warning">
                    <%= total_import %>
                </td>
                <% total_export = 0 %>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_WAREHOUSE_EXPORT
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_MANUFACTURER_EXPORT
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_transfer_export(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_gift_given_export(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_damage_record_export(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_stock_check_export(@global_filters.merge({
                            product_id: product_ids,
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num">
                    <%
                        count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                            product_id: product_ids,
                            delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOM_EXPORT
                        }))
                        total_export += count
                    %>
                    <%= count %>
                </td>
                <td class="text-center stock-num text-bold text-primary">
                    <%= total_export %>
                </td>



                <td class="text-center stock-num text-bold bg-info">
                    <%
                        end_params = @global_filters.clone
                        end_params[:from_date] = nil
                        end_params[:product_id] = product_ids
                    %>
                    <%= Erp::Products::Product.get_stock_real(end_params) %>
                </td>
            </tr>
            <tr>
                <th class="bg-primary text-center" rowspan="2"><%= t('.category') %></th>
                <th class="bg-primary text-center" rowspan="2" width="7%"><%= t('.begin') %></th>
                <th class="bg-primary text-center" colspan="7"><%= t('.import') %></th>
                <th class="bg-primary text-center text-center" colspan="8"><%= t('.export') %></th>
                <th class="bg-primary text-center" rowspan="2"><%= t('.end') %></th>
            </tr>
            <tr>
                <th class="bg-primary text-center" width="7%" title="Xuất kho">XK</th>
                <th class="bg-primary text-center" width="7%" title="Hoàn kho (Khách hàng)">HK</th>
                <th class="bg-primary text-center" width="7%" title="Chuyển kho">CK</th>
                <th class="bg-primary text-center" width="7%" title="Ký gởi/Cho mượn">KG</th>
                <th class="bg-primary text-center" width="7%" title="Kiểm kho">KK</th>
                <th class="bg-primary text-center" width="7%" title="Kiểm kho">Khác</th>
                <th class="bg-primary text-center" width="7%" title="Tổng cộng">Tổng</th>
                <th class="bg-primary text-center" width="7%" title="Xuất kho bán">XK</th>
                <th class="bg-primary text-center" width="7%" title="Trả nhà CC">TNCC</th>
                <th class="bg-primary text-center" width="7%" title="Chuyển kho">CK</th>
                <th class="bg-primary text-center" width="7%" title="Tặng quà">TQ</th>
                <th class="bg-primary text-center" width="7%" title="Hủy kho">HuyK</th>
                <th class="bg-primary text-center" width="7%" title="Kiểm kho">KK</th>
                <th class="bg-primary text-center" width="7%" title="Kiểm kho">Khác</th>
                <th class="bg-primary text-center" width="7%">Tổng</th>
            </tr>
            <% @categories.each_with_index do |category,index| %>
                <% product_ids = ([-1] + Erp::Products::Product.select('id').where("erp_products_products.category_id = ?", category.id)) %>
                <tr>
                    <td class="text-left"><%= category.name %></td>

                    <td class="text-center stock-num text-bold bg-warning">
                        <%
                            begin_params = @global_filters.clone
                            begin_params[:to_date] = @global_filters[:from_date]
                            begin_params[:from_date] = nil
                            begin_params[:product_id] = product_ids
                        %>
                        <%= Erp::Products::Product.get_stock_real(begin_params) %>
                    </td>

                    <% total_import = 0 %>
                    <td class="text-center stock-num">
                        <%
                            filters = @global_filters.clone
                            count = Erp::Products::Product.get_qdelivery_import(filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_WAREHOUSE_IMPORT
                            }))
                            total_import += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            filters = @global_filters.clone
                            count = Erp::Products::Product.get_qdelivery_import(filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOMER_IMPORT
                            }))
                            total_import += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_transfer_import(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_import += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        --
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_stock_check_import(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_import += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            filters = @global_filters.clone
                            count = Erp::Products::Product.get_qdelivery_import(filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOM_IMPORT
                            }))
                            total_import += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num text-bold text-warning">
                        <%= total_import %>
                    </td>

                    <% total_export = 0 %>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_WAREHOUSE_EXPORT
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_MANUFACTURER_EXPORT
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_transfer_export(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_gift_given_export(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_damage_record_export(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_stock_check_export(@global_filters.merge({
                                product_id: product_ids,
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num">
                        <%
                            count = Erp::Products::Product.get_qdelivery_export(@global_filters.merge({
                                product_id: product_ids,
                                delivery_type: Erp::Qdeliveries::Delivery::TYPE_CUSTOM_EXPORT
                            }))
                            total_export += count
                        %>
                        <%= count %>
                    </td>
                    <td class="text-center stock-num text-bold text-primary">
                        <%= total_export %>
                    </td>


                    <td class="text-center stock-num text-bold bg-info">
                        <%
                            end_params = @global_filters.clone
                            end_params[:from_date] = nil
                            end_params[:product_id] = product_ids
                        %>
                        <%= Erp::Products::Product.get_stock_real(end_params) %>
                    </td>
                </tr>
            <% end %>
        </table>
    <% elsif !@group_by_category.nil? %>
        <%= render 'erp/ortho_k/backend/products/delivery_report_table/by_category_property' %>
    <% else %>
        <%= render 'erp/ortho_k/backend/products/delivery_report_table/by_property' %>
    <% end %>
<% else %>
    <div class="alert alert-warning">
        <p>Vui lòng chọn các tham số bắt buộc:
            <br>- <strong>Từ ngày</strong>
            <br>- <strong>Đến ngày</strong>
        </p>
    </div>
<% end %>
