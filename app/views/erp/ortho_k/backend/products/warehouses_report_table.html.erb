<% col_width = 70/@warehouses.count %>
<% if @group_by_category.nil? and @group_by_property.nil? %>
    <table class="table table-bordered table-advance order-column" id="">
        <tr>
            <td class="text-right text-bold"><%= t('.total_row') %></td>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <%
                    count = Erp::Products::Product.get_qdelivery_import(@global_filters.merge({
                        product_id: [-1] + @products.select('id'),
                        warehouse: warehouse,
                    }))
                %>
                <td class="text-center stock-num text-bold text-num-<%= count %>">
                    <%= count %>
                </td>
            <% end %>
        </tr>
        <tr>
            <th class="bg-primary text-center"><%= t('.name') %></th>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <th class="bg-primary text-center" width="<%= col_width %>%"><%= warehouse.name %></th>
            <% end %>
        </tr>
        <% @products.each_with_index do |product,index| %>
            <tr>
                <td class="text-left"><%= product.name %></td>
                <% @warehouses.each_with_index do |warehouse,index| %>
                    <%
                        count = Erp::Products::Product.get_qdelivery_import(@global_filters.merge({
                            product_id: product.id,
                            warehouse: warehouse,
                        }))
                    %>
                    <td class="text-center stock-num text-num-<%= count %>">
                        <%= count %>
                    </td>
                <% end %>
            </tr>
        <% end %>
    </table>
    <%= erp_datalist_pagination(@products) %>

<!-- Group by category  -->
<% elsif @group_by_property.nil? %>
    <table class="table table-bordered table-advance order-column" id="">
        <tr>
            <td class="text-right text-bold"><%= t('.total_row') %></td>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <%
                    count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                        product_id: [-1] + @products.select('id').where(category_id: @group_by_category),
                        warehouse: warehouse,
                    }))
                %>
                <td class="text-center stock-num text-bold text-num-<%= count %>">
                    <%= count %>
                </td>
            <% end %>
        </tr>
        <tr>
            <th class="bg-primary text-center">Loại</th>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <th class="bg-primary text-center" width="<%= col_width %>%"><%= warehouse.name %></th>
            <% end %>
        </tr>
        <% @categories.each_with_index do |category,index| %>
            <tr>
                <td class="text-left"><%= category.name %></td>
                <% @warehouses.each_with_index do |warehouse,index| %>
                    <%
                        count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                            product_id: [-1] + @products.select('id').where(category_id: category.id),
                            warehouse: warehouse,
                        }))
                    %>
                    <td class="text-center stock-num text-num-<%= count %>">
                        <%= count %>
                    </td>
                <% end %>
            </tr>
        <% end %>
    </table>

<!-- Group by category + property  -->
<% elsif !@group_by_category.nil? %>
    <table class="table table-bordered table-advance order-column" id="">
        <tr>
            <td class="text-right text-bold" colspan="2"><%= t('.total_row') %></td>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <%
                    count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                        product_id: [-1] + @products.select('id').where(category_id: @group_by_category),
                        warehouse: warehouse,
                    }))
                %>
                <td class="text-center stock-num text-bold text-num-<%= count %>">
                    <%= count %>
                </td>
            <% end %>
        </tr>
        <tr>
            <th class="bg-primary text-center">Loại</th>
            <th class="bg-primary text-center">Thuộc tính</th>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <th class="bg-primary text-center" width="<%= col_width %>%"><%= warehouse.name %></th>
            <% end %>
        </tr>
        <% @categories.each_with_index do |category,index| %>
            <% rowspan = @properties_values.count %>
            <% @properties_values.each_with_index do |property_value,index| %>
                <tr>
                    <% if index == 0 %>
                        <td class="text-left text-bold" rowspan="<%= rowspan %>"><%= category.name %></td>
                    <% end %>
                    <td class="text-left"><%= property_value.value %></td>
                    <% @warehouses.each_with_index do |warehouse,index| %>
                        <%
                            count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                                product_id: [-1] + @products.select('id')
                                    .where(category_id: category.id)
                                    .where("erp_products_products.cache_properties LIKE '%[\"#{property_value.id}\",%'"),
                                warehouse: warehouse,
                            }))
                        %>
                        <td class="text-center stock-num text-num-<%= count %>">
                            <%= count %>
                        </td>
                    <% end %>
                </tr>
            <% end %>
        <% end %>
    </table>

<!-- Group by property  -->
<% else %>
    <table class="table table-bordered table-advance order-column" id="">
        <tr>
            <td class="text-right text-bold"><%= t('.total_row') %></td>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <%
                    count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                        product_id: [-1] + @products.select('id'),
                        warehouse: warehouse,
                    }))
                %>
                <td class="text-center stock-num text-bold text-num-<%= count %>">
                    <%= count %>
                </td>
            <% end %>
        </tr>
        <tr>
            <th class="bg-primary text-center"><%= t('.property') %></th>
            <% @warehouses.each_with_index do |warehouse,index| %>
                <th class="bg-primary text-center" width="<%= col_width %>%"><%= warehouse.name %></th>
            <% end %>
        </tr>
        <% @properties_values.each_with_index do |properties_value,index| %>
            <tr>
                <td class="text-left"><%= properties_value.value %></td>
                <% @warehouses.each_with_index do |warehouse,index| %>
                    <%
                        count = Erp::Products::Product.get_stock_real(@global_filters.merge({
                            product_id: [-1] + @products.select('id')
                                .where("erp_products_products.cache_properties LIKE '%[\"#{properties_value.id}\",%'"),
                            warehouse: warehouse,
                        }))
                    %>
                    <td class="text-center stock-num text-num-<%= count %>">
                        <%= count %>
                    </td>
                <% end %>
            </tr>
        <% end %>
    </table>
<% end %>
