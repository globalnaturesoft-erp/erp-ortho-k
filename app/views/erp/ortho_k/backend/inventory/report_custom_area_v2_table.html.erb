<% if @letter_array.empty? %>
  <div class="alert alert-warning">
      <p>Vui lòng chọn các tham số bắt buộc:
          <br>- <strong>Vùng len</strong>
      </p>
  </div>
<% else %>

  <div class="custom-show text-center">
      <h4 class="font-yellow bold uppercase mb-15">
          Báo cáo tồn kho
          <% if @period.present? %>
              <%= @period.name %>
          <% else %>
              <%= 'Từ ' + @from_date.strftime('%d/%m/%Y') if !@from_date.nil? %> <%= ' Đến ' + @to_date.strftime('%d/%m/%Y') if !@to_date.nil? %>
          <% end %>
      </h4>
  </div>

  <div class="text-right mb-10">
      <a target="_blank"
          href="<%= erp_ortho_k.report_custom_area_xlsx_backend_inventory_index_path(params.to_unsafe_hash.merge({format: 'xlsx'})) %>"
          target="_blank"
          class="btn btn-primary"
      >Xuất excel</a>
  </div>

  <table class="table table-bordered table-advance order-column">
    <tr>
      <th rowspan="2" class="text-center bg-primary">Loại hàng</th>
      <th rowspan="2" class="text-center bg-primary">Đường kính</th>
      <th rowspan="2" class="text-center bg-primary">Vùng len</th>
      <th colspan="2" class="text-center bg-primary">Số lượng</th>
      <th rowspan="2" class="text-center bg-primary">Chênh lệch</th>
    </tr>
    <tr>
      <th class="text-center bg-primary">Đầu kỳ</th>
      <th class="text-center bg-primary">Cuối kỳ</th>
    </tr>


    <% @letter_array.each_with_index do |row,index| %>
      <%
        letters = row[:letters]
        letter_ids = row[:letter_ids]
      %>
      <tr>
        <%
          query = @product_query
          # filter by letters
          if letter_ids.present?
            if !letter_ids.kind_of?(Array)
              query = query.where("erp_products_products.cache_properties LIKE '%[\"#{letter_ids}\",%'")
            else
              letter_ids = (letter_ids.reject { |c| c.empty? })
              if !letter_ids.empty?
                qs = []
                letter_ids.each do |x|
                  qs << "(erp_products_products.cache_properties LIKE '%[\"#{x}\",%')"
                end
                query = query.where("(#{qs.join(" OR ")})")
              end
            end
          end
          product_ids = query.select('id')
        %>
        <% product_ids = -1 if product_ids.count == 0 %>
        <% filters = @global_filters.clone.merge({product_id: product_ids}) %>

        <% if index == 0 %>
          <td class="text-left text-bold" rowspan="<%= @letter_array.count %>">
            <% if @categories.empty? %>
              Tất cả loại
            <% else %>
              <%= @categories.map(&:name).join("<br />").html_safe %>
            <% end %>
          </td>
          <td class="text-left text-bold" rowspan="<%= @letter_array.count %>">
            <% if @diameters.empty? %>
              Tất cả loại
            <% else %>
              <%= @diameters.map(&:value).join(", ").html_safe %>
            <% end %>
          </td>
        <% end %>



        <td class="text-left text-bold">
          <% if letters.empty? %>
            Tất cả loại
          <% else %>
            <%= letters.map(&:value).join(", ").html_safe %>
          <% end %>
        </td>
        <td class="text-center text-bold">
          <%
              begin_params = filters.clone
              begin_params[:to_date] = filters[:from_date]
              begin_params[:from_date] = nil
          %>
          <% begin_amount = Erp::Products::Product.get_stock_real(begin_params) %>
          <%= begin_amount %>
        </td>
        <td class="text-center text-bold">
          <%
              end_params = filters.clone
              end_params[:from_date] = nil
          %>
          <% end_amount = Erp::Products::Product.get_stock_real(end_params) %>
          <%= end_amount %>
        </td>
        <td class="text-center text-bold">
          <%= end_amount - begin_amount %>
        </td>
      </tr>

    <% end %>
  </table>
<% end %>
