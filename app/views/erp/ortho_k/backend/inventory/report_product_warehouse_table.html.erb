<% if @categories.empty? %>
  <div class="alert alert-warning">
      <p>Vui lòng chọn các tham số bắt buộc:
          <br>- <strong>Loại hàng</strong>
      </p>
  </div>
<% else %>
  <div class="custom-show text-center">
      <h4 class="font-yellow bold uppercase mb-15">
          Báo cáo tồn kho
          <% if @period.present? %>
              <%= @period.name %>
          <% else %>
              <%= 'Từ ' + @from_date.strftime('%d/%m/%Y') if !@from_date.nil? %> <%= ' Đến ' + @to_date.strftime('%d/%m/%Y') if !@to_date.nil? %>
          <% end %>
      </h4>
  </div>

  <div class="text-right mb-10">
      <a target="_blank"
          href="<%= erp_ortho_k.report_product_warehouse_xlsx_backend_inventory_index_path({format: 'xlsx'}) %>"
          target="_blank"
          class="btn btn-primary"
      >Xuất excel</a>
  </div>

  <table class="table table-bordered table-advance order-column datalist-scroll">
    <thead>
        <% if params[:just_rows] != '1' %>
          <% product_ids = @product_query.select('id') %>
          <% product_ids = -1 if product_ids.count == 0 %>
          <% filters = @global_filters.clone.merge({product_id: product_ids}) %>
          <tr>
            <th colspan="2" class="text-right bg-grey">Tổng cộng</th>
            <% @warehouses.each do |warehouse| %>
              <% filters = @global_filters.clone.merge({
                product_id: product_ids,
                warehouse: warehouse,
              }) %>
              <th class="text-center bg-grey"><%= Erp::Products::Product.get_stock_real(filters) %></th>
            <% end %>
            <% filters = @global_filters.clone.merge({
                product_id: product_ids
              }) %>
            <th class="text-center bg-grey"><%= Erp::Products::Product.get_stock_real(filters) %></th>
          </tr>

          <tr>
            <th class="text-center bg-primary">Sản phẩm</th>
            <th class="text-center bg-primary">Đơn vị</th>
            <% @warehouses.each do |warehouse| %>
              <th class="text-center bg-primary"><%= warehouse.short_name %></th>
            <% end %>
            <th class="text-center bg-primary">Tất cả</th>
          </tr>
        <% end %>
    </thead>

    <% @products.each do |product| %>
      <tr>
        <td class="text-semibold"><%= product.name %></td>
        <td class="text-center"><%= product.unit_name %></td>
        <% @warehouses.each do |warehouse| %>
          <% filters = @global_filters.clone.merge({
            warehouse: warehouse,
            product_id: product.id,
          }) %>
          <td class="text-center"><%= Erp::Products::Product.get_stock_real(filters) %></td>
        <% end %>

        <% filters = @global_filters.clone.merge({
          product_id: product.id,
        }) %>
        <td class="text-center"><%= Erp::Products::Product.get_stock_real(filters) %></td>
      </tr>
    <% end %>
  </table>

  <%= erp_datalist_pagination(@products) %>
<% end %>
